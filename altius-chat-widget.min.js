// Konfigurasi kredensial API dan data pengguna

!(function () {
  "use strict";
  if (!window.AltiusChatWidget) {
    // Objek konfigurasi tema yang berisi semua variabel styling
    const theme = {
      colors: {
        primary: "#1EC0AA",
        primaryDark: "#179e8c",
        secondary: "#10b981", // Warna untuk status terbuka
        text: {
          primary: "#ffffff",
          secondary: "#374151",
          muted: "#9ca3af",
        },
        background: {
          main: "#f9fafb",
          chat: "#f8fafc",
          input: "#ffffff",
        },
        border: "#1EC0AA",
        shadow: {
          light: "rgba(30, 192, 170, 0.15)",
          medium: "rgba(30, 192, 170, 0.2)",
          dark: "rgba(30, 192, 170, 0.12)",
        },
      },
      spacing: {
        xs: "4px",
        sm: "8px",
        md: "12px",
        lg: "16px",
        xl: "20px",
        xxl: "24px",
      },
      borderRadius: {
        full: "50%",
        lg: "24px",
        md: "18px",
        sm: "12px",
        xs: "4px",
      },
      typography: {
        fontFamily:
          "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif",
        fontSize: {
          sm: "14px",
          base: "16px",
          lg: "18px",
        },
        fontWeight: {
          normal: "400",
          medium: "500",
          semibold: "600",
          bold: "700",
        },
      },
      layout: {
        widget: {
          position: "bottom-right",
          zIndex: "999999",
        },
        bubble: {
          size: "60px",
          iconSize: "24px",
        },
        popup: {
          width: "380px",
          height: "500px",
          mobile: {
            width: "calc(100vw - 40px)",
            height: "calc(100vh - 120px)",
          },
        },
      },
      transitions: {
        default: "all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",
        fast: "all 0.2s cubic-bezier(0.4, 0, 0.2, 1)",
        slow: "all 0.5s cubic-bezier(0.4, 0, 0.2, 1)",
        bounce: "all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55)",
      },
      animations: {
        typing: {
          duration: "1.4s",
          timing: "ease-in-out",
        },
        pulse: {
          duration: "2s",
          timing: "ease-in-out",
        },
      },
    };

    // Global variables to store user agent data
    let userAgentData = {
      useragent_name: "Altius People",
      bot_name: "Altius Assistant",
      bot_logo_url:
        "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTQyIDc5LjE2MDkyNCwgMjAxNy8wNy8xMy0wMTowNjozOSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTggKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkU3OUJGRDU3NEI1MTExRjA5RUMzOUMyNkNDRjkyRTg0IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkU3OUJGRDU4NEI1MTExRjA5RUMzOUMyNkNDRjkyRTg0Ij4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6RTc5QkZENTU0QjUxMTFGMDlFQzM5QzI2Q0NGOTJFODQiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6RTc5QkZENTY0QjUxMTFGMDlFQzM5QzI2Q0NGOTJFODQiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz4eA3aDAAAC80lEQVR42syYX4gNURzH5969yvpzlV3h5i7lxSJ3pVYiYhUR8i+51nq5m+wKJTx4ULIvlAehZCT/pkQibZKQF0rywAMpyp9CHrRErjbX5+Tc9prMzJmZM2ZOfc+ZO3fumc/5/c75nd+5RqVSMUIVy2xHYw3NRXAJpTX0tQmtNyIq6ZDWy1EvQBuTCWgYRdlHC7BTkgjY7nCtraTEREylUkHcO5X6ac2dd2i8USz90rVIwlrQPu/GobnJcLFlpuX8c3N5rHNwnrSYvawFfnASAJ3CShYtjxfQMuupV7s8sSFuCy6TlnIqSxhEQ5yAXrtGBq2LB9AyG6kXaxiEcsn4fH4y6lWJswxmBEG7T1vETlqppluZOF6eXbp3CE2TVL6mFRqOjqOz4fZi55eLQedqXtxkAxDXIx1+fgHt/NLb87Hq2UwAgFG2l+VtELkA0eEF2gLYHddF4mH66n2dW1kZ9aCDwJUdVzFg+2i2uZg+inJLWu2lUj4I5Bo+H0WjIwb7gHYAdtFXPsgPLtM0o9MRgYlE9hia5AXnmVFjzTaaE2iiJrjHaDNgj7Rk1HR0m2YaOhwS7Kuc261+4JTPJFhSpPD3AsJdQtsBex9mh/OKgx0B+n6FugC7GempDuvVyxWXVezrJzqEDgD3Q1eO4GbBFT7g7kqrPf+fhyYV936Sz7W5wllmAbVqywdx7xiaRa75nmGcQrsB++yR5IqQdQVdCzKn0y4HH6fvnqDZgHUqwIl+bsipsorPw3QB/itl/4Z2oRmAPVA4HuyhPo8GyTtDPU6Dai7GvQWagu32VRFwAXurAFZHfUQsGod5fSasBWvnyRtxEAdspRLcwKArUvYynwHkAwNivTo5//plTGsG7LovnxRLZbSVqznomT3u+j3x2S24EIn8bDpgYoV+DxzAiqX7oh+0XwbxQLvTXzsJFpxA8xowvUe9P/++nkSz5J2ZDOChyk6i/dDkAim81S1T/HMAdicLcAA0L93eCWS/F+BvAQYAY/cSG57y",
    };

    // Fungsi untuk mengambil detail user agent dari API
    async function fetchUserAgentDetails() {
      const token = window.chat_api_key;
      const api_tenant = window.chat_api_tenant;
      if (!token) {
        console.warn(
          "No authentication token available for user agent details"
        );
        return;
      }

      try {
        const response = await fetch(
          `https://aionegml-dev-c3aqcqg7abhhb2ag.southeastasia-01.azurewebsites.net/detail_useragent/${token}`,
          {
            method: "GET",
            headers: {
              "qubisa-api-key": api_tenant,
            },
          }
        );

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log("agent detail", data.data.detail_collection[0].bot_name);

        if (
          data.success &&
          data.data &&
          data.data.detail_collection &&
          data.data.detail_collection.length > 0
        ) {
          const agentDetail = data.data.detail_collection[0];
          userAgentData = {
            useragent_name: agentDetail.useragent_name || "Altius People",
            bot_name: agentDetail.bot_name,
            bot_logo_url:
              agentDetail.bot_logo_url || userAgentData.bot_logo_url,
          };

          // Update the header elements if they exist
          updateHeaderElements();
        }
      } catch (error) {
        console.error("Error fetching user agent details:", error);
      }
    }

    // Fungsi untuk memperbarui elemen header dengan data user agent
    function updateHeaderElements() {
      const titleElement = document.querySelector(
        ".ai-altius-altius-chat-title"
      );
      const logoElement = document.querySelector(".ai-altius-altius-logo-img");

      if (titleElement) {
        titleElement.textContent = userAgentData.useragent_name;
      }

      if (logoElement) {
        logoElement.src = userAgentData.bot_logo_url;
        logoElement.alt = `${userAgentData.bot_name} Logo`;
      }
    }

    // Fungsi untuk menghasilkan CSS styles dari konfigurasi tema
    const generateStyles = () => `
      .ai-altius-altius-chat-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: ${theme.layout.widget.zIndex};
        font-family: ${theme.typography.fontFamily};
      }
      
      .ai-altius-altius-chat-bubble {
        width: ${theme.layout.bubble.size};
        height: ${theme.layout.bubble.size};
        background: #ef4444;
        border-radius: ${theme.borderRadius.full};
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 12px ${theme.colors.shadow.light};
        transition: ${theme.transitions.bounce};
        border: none;
        outline: none;
        position: relative;
        overflow: hidden;
      }
      
      .ai-altius-altius-chat-bubble::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
        opacity: 0;
        transition: ${theme.transitions.fast};
        border-radius: ${theme.borderRadius.full};
      }
      
      .ai-altius-altius-chat-bubble:hover::before {
        opacity: 1;
      }
      
      .ai-altius-altius-chat-bubble:hover {
        background: #dc2626;
      }
      
      .ai-altius-altius-chat-bubble:active {
        transform: scale(0.95);
      }
      
      .ai-altius-altius-chat-bubble.open {
        /* transform: scale(1.1); */
        box-shadow: 0 6px 20px ${theme.colors.shadow.medium};
      }
      
      .ai-altius-altius-chat-bubble.open .ai-altius-altius-chat-icon {
        opacity: 0;
        transform: scale(0.8) rotate(-90deg);
      }
      
      .ai-altius-altius-chat-bubble.open .ai-altius-altius-close-icon {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1) rotate(0deg);
      }
      
      .ai-altius-altius-chat-bubble .ai-altius-altius-chat-icon {
        width: ${theme.layout.bubble.iconSize};
        height: ${theme.layout.bubble.iconSize};
        fill: #fff;
        transition: ${theme.transitions.bounce};
        position: relative;
        z-index: 1;
        opacity: 1;
        transform: scale(1) rotate(0deg);
      }
      
      .ai-altius-altius-chat-bubble .ai-altius-altius-close-icon {
        width: 24px;
        height: 24px;
        fill: #fff;
        transition: ${theme.transitions.bounce};
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.8) rotate(90deg);
        z-index: 1;
        opacity: 0;
      }
      
      .ai-altius-altius-chat-popup {
        position: absolute;
        bottom: 80px;
        right: 0;
        width: 360px;
        height: 500px;
        max-height: 82vh;
        background: ${theme.colors.background.input};
        border-radius: ${theme.borderRadius.sm};
        box-shadow: 0 8px 32px ${theme.colors.shadow.dark};
        display: none;
        flex-direction: column;
        overflow: hidden;
        transform: translateY(20px) scale(0.95);
        opacity: 0;
        transition: ${theme.transitions.bounce};
        transform-origin: bottom right;
      }
      
      .ai-altius-altius-chat-popup.show {
        display: flex;
        transform: translateY(0) scale(1);
        opacity: 1;
      }
      
      .ai-altius-altius-chat-header {
        flex: 0 0 9%;
        min-height: 34px;
        max-height: 13%;
        background: #1EC0AA;
        color: #fff;
        padding: 12px 15px 12px 18px;
        display: flex;
        align-items: center;
        gap: 14px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 18px 0 rgba(30,192,170,0.10);
        transition: background 0.4s, box-shadow 0.3s;
      }
      .ai-altius-altius-chat-header:hover {
        box-shadow: 0 8px 32px 0 rgba(30,192,170,0.18);
        background: #179e8c;
      }
      .ai-altius-altius-chat-logo {
        width: 24px;
        height: 24px;
        background: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px 0 #1EC0AA88, 0 0 0 2px #fff;
        padding: 2px;
        overflow: visible;
        margin-right: 0px;
        transition: box-shadow 0.3s;
      }
      .ai-altius-altius-logo-img {
        width: 30px;
        height: 30px;
        object-fit: contain;
        display: block;
        border-radius: 50%;
        background: #fff;
        box-shadow: none;
      }
      .ai-altius-altius-chat-title {
        font-size: 15px;
        font-weight: 800;
        letter-spacing: 0.5px;
        margin-bottom: 1px;
        animation: altius-title-slide 0.5s ease-out 0.2s both;
      }
      .ai-altius-altius-chat-status {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 12px;
        color: #e0e7ef;
        font-weight: 500;
        margin-top: 1px;
      }
      .ai-altius-altius-chat-status-dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: #22c55e;
        box-shadow: 0 0 4px #22c55e99;
        display: inline-block;
      }
      
      .ai-altius-altius-chat-content {
        flex: 1 1 68%;
        min-height: 0;
        max-height: 70%;
        background: ${theme.colors.background.chat};
        padding: ${theme.spacing.xl};
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: ${theme.spacing.md};
      }
      
      .ai-altius-altius-chat-message {
        max-width: 80%;
        padding: ${theme.spacing.md} ${theme.spacing.lg};
        border-radius: ${theme.borderRadius.md};
        font-size: ${theme.typography.fontSize.sm};
        line-height: 1.4;
        display: flex;
        flex-direction: column;
        gap: ${theme.spacing.xs};
        animation: altius-message-slide 0.4s ease-out both;
        transform-origin: bottom;
      }
      
      .ai-altius-altius-chat-message.bot {
        animation-delay: 0.1s;
      }
      
      .ai-altius-altius-chat-message.user {
        animation-delay: 0.2s;
      }
      
      @keyframes altius-message-slide {
        from {
          opacity: 0;
          transform: translateY(20px) scale(0.9);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      
      .ai-altius-altius-chat-message-header {
        font-size: 12px;
        color: ${theme.colors.text.muted};
        display: flex;
        justify-content: space-between;
        align-items: center;
        min-width: 80px;
        gap: 12px;
      }
      
      .ai-altius-altius-chat-message-content {
        word-break: break-word;
        text-align: left;
      }
      
      .ai-altius-altius-chat-message.bot {
        background: ${theme.colors.background.input};
        color: ${theme.colors.text.secondary};
        align-self: flex-start;
        border-bottom-left-radius: ${theme.borderRadius.xs};
        border: 1px solid #a0ede3;
        box-shadow: 0 2px 8px rgba(30, 192, 170, 0.10);
      }
      
      .ai-altius-altius-chat-message.user {
        background: #e6faf8; /* warna soft teal */
        color: #179e8c;      /* warna teks lebih gelap */
        align-self: flex-end;
        border-bottom-right-radius: ${theme.borderRadius.xs};
        border: 1px solid #a0ede3;
        box-shadow: 0 2px 8px rgba(30, 192, 170, 0.10);
      }

      .ai-altius-altius-chat-input-area {
        flex: 0 0 12%;
        min-height: 44px;
        max-height: 18%;
        display: flex;
        align-items: center;
        gap: 9px;
        padding: 11px 16px;
        background: #fff;
        border-top: 1.5px solid #f3f4f6;
        border-radius: 0 0 16px 16px;
        box-sizing: border-box;
      }
      
      .ai-altius-altius-chat-input {
        flex: 1;
        border: 1.5px solid #a0ede3;
        border-radius: 999px;
        padding: 10px 14px;
        font-size: 15px;
        outline: none;
        transition: border 0.2s, box-shadow 0.2s;
        box-shadow: 0 2px 8px rgba(30, 192, 170, 0.04);
      }
      
      .ai-altius-altius-chat-input:focus {
        border-color: #1EC0AA;
        box-shadow: 0 0 0 2px rgba(30, 192, 170, 0.15);
      }
      
      .ai-altius-altius-chat-input::placeholder {
        color: #bdbdbd;
        font-size: 15px;
        opacity: 1;
      }
      
      .ai-altius-altius-chat-send {
        width: 38px;
        height: 38px;
        font-size: 18px;
        border-radius: 50%;
        background: #1EC0AA;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 16px rgba(30, 192, 170, 0.18);
        cursor: pointer;
        border: none;
        transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
        position: relative;
      }
      
      .ai-altius-altius-chat-send:hover {
        background: #179e8c;
        transform: scale(1.08);
        box-shadow: 0 6px 24px rgba(30, 192, 170, 0.25);
      }
      
      .ai-altius-altius-chat-send:active {
        background: #117c6b;
        transform: scale(0.96);
      }
      
      .ai-altius-altius-chat-send-icon {
        width: 19px;
        height: 19px;
        fill: #fff;
        transition: transform 0.2s;
      }
      
      .ai-altius-altius-chat-send:hover .ai-altius-altius-chat-send-icon {
        transform: translateX(2px);
      }
      
      .ai-altius-altius-chat-send:disabled {
        background: #f3f4f6;
        color: #ccc;
        cursor: not-allowed;
        box-shadow: none;
        opacity: 0.6;
        transform: none;
      }
      .ai-altius-altius-chat-send:disabled .ai-altius-altius-chat-send-icon {
        fill: #ccc;
      }
      
      .ai-altius-altius-chat-close {
        position: absolute;
        bottom: -50px;
        right: 10px;
        width: 44px;
        height: 44px;
        background: #fff;
        border: 1.5px solid #e5e7eb;
        border-radius: 50%;
        color: #dc2626;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.10);
        transition: background 0.2s, color 0.2s, box-shadow 0.2s, transform 0.2s;
        outline: none;
        animation: altius-close-bounce 0.6s ease-out 0.4s both;
        z-index: 10;
      }
      
      @keyframes altius-close-bounce {
        0% {
          opacity: 0;
          transform: scale(0) rotate(-180deg);
        }
        50% {
          transform: scale(1.2) rotate(0deg);
        }
        100% {
          opacity: 1;
          transform: scale(1) rotate(0deg);
        }
      }
      
      .ai-altius-altius-chat-close:hover {
        background: #e6faf8;
        color: #179e8c;
        box-shadow: 0 4px 16px rgba(30, 192, 170, 0.18);
        transform: scale(1.12) rotate(10deg);
        border-color: #a0ede3;
      }
      
      .ai-altius-altius-close-icon {
        width: 24px;
        height: 24px;
        fill: currentColor;
        transition: ${theme.transitions.fast};
        display: block;
      }
      
      .ai-altius-altius-typing-indicator {
        display: flex;
        align-items: center;
        gap: ${theme.spacing.xs};
        padding: ${theme.spacing.md} ${theme.spacing.lg};
        background: ${theme.colors.background.input};
        border-radius: ${theme.borderRadius.md};
        border-bottom-left-radius: ${theme.borderRadius.xs};
        align-self: flex-start;
        max-width: 80px;
        animation: altius-typing-fade 0.3s ease-out;
      }
      
      @keyframes altius-typing-fade {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .ai-altius-altius-typing-dot {
        width: 6px;
        height: 6px;
        background: ${theme.colors.text.muted};
        border-radius: ${theme.borderRadius.full};
        animation: altius-typing ${theme.animations.typing.duration} ${theme.animations.typing.timing} infinite;
      }
      
      .ai-altius-altius-typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      
      .ai-altius-altius-typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }
      
      @keyframes altius-typing {
        0%, 60%, 100% {
          transform: translateY(0) scale(1);
          opacity: 0.5;
        }
        30% {
          transform: translateY(-10px) scale(1.2);
          opacity: 1;
        }
      }
      
      @keyframes ripple {
        to {
          transform: scale(4);
          opacity: 0;
        }
      }
      
      @media (max-width: 480px) {
        .ai-altius-altius-chat-popup {
          width: 98vw;
          max-width: 300px;
          height: 68vh;
          max-height: 82vh;
          bottom: 50px;
          right: 4px;
          left: 4px;
          border-radius: 16px;
        }
        .ai-altius-altius-chat-header {
          flex: 0 0 11%;
          min-height: 30px;
          max-height: 15%;
          padding: 9px 12px 9px 14px;
        }
        .ai-altius-altius-chat-content {
          flex: 1 1 72%;
          min-height: 0;
          max-height: 70%;
        }
        .ai-altius-altius-chat-input-area {
          flex: 0 0 14%;
          min-height: 36px;
          max-height: 20%;
          padding: 7px 7px;
          gap: 5px;
          border-radius: 0 0 10px 10px;
        }
        .ai-altius-altius-chat-input {
          padding: 6px 8px;
          font-size: 12px;
        }
        .ai-altius-altius-chat-send {
          width: 24px;
          height: 24px;
          font-size: 13px;
        }
        .ai-altius-altius-chat-send-icon {
          width: 12px;
          height: 12px;
        }
      }

      /* Responsive design for various laptop screen sizes */
      
      /* Large Desktop (1920px and above) */
      @media (min-width: 1920px) {
        .ai-altius-altius-chat-popup {
          width: 390px;
          height: 540px;
          max-height: 82vh;
          bottom: 100px;
          right: 40px;
        }
        
        .ai-altius-altius-chat-bubble {
          width: 70px;
          height: 70px;
        }
        
        .ai-altius-altius-chat-bubble .ai-altius-altius-chat-icon {
          width: 28px;
          height: 28px;
        }
        
        .ai-altius-altius-chat-header {
          max-height: 80px;
        }
        
        .ai-altius-altius-chat-logo {
          width: 42px;
          height: 42px;
        }
        
        .ai-altius-altius-chat-title {
          font-size: 18px;
        }
        
        .ai-altius-altius-chat-content {
          max-height: calc(100% - 80px);
        }
        
        .ai-altius-altius-chat-input-area {
          padding: 14px 14px;
        }
        
        .ai-altius-altius-chat-input {
          padding: 14px 18px;
          font-size: 16px;
        }
        
        .ai-altius-altius-chat-send {
          width: 52px;
          height: 52px;
        }
        
        .ai-altius-altius-chat-send-icon {
          width: 28px;
          height: 28px;
        }
      }
      
      /* Standard Desktop (1366px - 1919px) */
      @media (min-width: 1366px) and (max-width: 1919px) {
        .ai-altius-altius-chat-popup {
          width: 360px;
          height: 500px;
          max-height: 82vh;
          bottom: 80px;
          right: 8px;
        }
        
        .ai-altius-altius-chat-bubble {
          width: 60px;
          height: 60px;
        }
        
        .ai-altius-altius-chat-bubble .ai-altius-altius-chat-icon {
          width: 26px;
          height: 26px;
        }
        
        .ai-altius-altius-chat-header {
          max-height: 78px;
        }
        
        .ai-altius-altius-chat-logo {
          width: 36px;
          height: 36px;
        }
        
        .ai-altius-altius-chat-title {
          font-size: 17px;
        }
        
        .ai-altius-altius-chat-content {
          max-height: calc(100% - 72px);
        }
        
        .ai-altius-altius-chat-input-area {
          padding: 12px 12px;
          
          
        }
        
        .ai-altius-altius-chat-input {
          padding: 13px 17px;
          font-size: 15px;
        }
        
        .ai-altius-altius-chat-send {
          width: 50px;
          height: 50px;
        }
        
        .ai-altius-altius-chat-send-icon {
          width: 22px;
          height: 22px;
        }
      }
      
      /* Small Desktop (1024px - 1365px) */
      @media (min-width: 1024px) and (max-width: 1365px) {
        .ai-altius-altius-chat-popup {
          width: 340px;
          height: 460px;
          max-height: 82vh;
          bottom: 75px;
          right: 25px;
        }
        
        .ai-altius-altius-chat-bubble {
          width: 62px;
          height: 62px;
        }
        
        .ai-altius-altius-chat-bubble .ai-altius-altius-chat-icon {
          width: 25px;
          height: 25px;
        }
        
        .ai-altius-altius-chat-header {
          max-height: 64px;
        }
        
        .ai-altius-altius-chat-logo {
          width: 38px;
          height: 38px;
        }
        
        .ai-altius-altius-chat-title {
          font-size: 16px;
        }
        
        .ai-altius-altius-chat-content {
          max-height: calc(100% - 64px);
        }
        
        .ai-altius-altius-chat-input-area {
          padding: 10px 10px;
        }
        
        .ai-altius-altius-chat-input {
          padding: 12px 16px;
          font-size: 14px;
        }
        
        .ai-altius-altius-chat-send {
          width: 48px;
          height: 48px;
        }
        
        .ai-altius-altius-chat-send-icon {
          width: 25px;
          height: 25px;
        }
      }
      
      /* Tablet Landscape (768px - 1023px) */
      @media (min-width: 768px) and (max-width: 1023px) {
        .ai-altius-altius-chat-popup {
          width: 310px;
          height: 420px;
          max-height: 82vh;
          bottom: 70px;
          right: 20px;
        }
        
        .ai-altius-altius-chat-bubble {
          width: 60px;
          height: 60px;
        }
        
        .ai-altius-altius-chat-bubble .ai-altius-altius-chat-icon {
          width: 24px;
          height: 24px;
        }
        
        .ai-altius-altius-chat-header {
          max-height: 56px;
        }
        
        .ai-altius-altius-chat-logo {
          width: 36px;
          height: 36px;
        }
        
        .ai-altius-altius-chat-title {
          font-size: 15px;
        }
        
        .ai-altius-altius-chat-content {
          max-height: calc(100% - 56px);
        }
        
        .ai-altius-altius-chat-input-area {
          padding: 8px 8px;
        }
        
        .ai-altius-altius-chat-input {
          padding: 11px 15px;
          font-size: 14px;
        }
        
        .ai-altius-altius-chat-send {
          width: 46px;
          height: 46px;
        }
        
        .ai-altius-altius-chat-send-icon {
          width: 24px;
          height: 24px;
        }
      }
      
      /* Tablet Portrait (481px - 767px) */
      @media (min-width: 481px) and (max-width: 767px) {
        .ai-altius-altius-chat-popup {
          width: 98vw;
          max-width: 320px;
          height: 74vh;
          max-height: 82vh;
          bottom: 65px;
          right: 15px;
        }
        
        .ai-altius-altius-chat-bubble {
          width: 58px;
          height: 58px;
        }
        
        .ai-altius-altius-chat-bubble .ai-altius-altius-chat-icon {
          width: 23px;
          height: 23px;
        }
        
        .ai-altius-altius-chat-header {
          max-height: 52px;
        }
        
        .ai-altius-altius-chat-logo {
          width: 34px;
          height: 34px;
        }
        
        .ai-altius-altius-chat-title {
          font-size: 14px;
        }
        
        .ai-altius-altius-chat-content {
          max-height: calc(100% - 52px);
        }
        
        .ai-altius-altius-chat-input-area {
          padding: 8px 8px;
        }
        
        .ai-altius-altius-chat-input {
          padding: 10px 14px;
          font-size: 13px;
        }
        
        .ai-altius-altius-chat-send {
          width: 44px;
          height: 44px;
        }
        
        .ai-altius-altius-chat-send-icon {
          width: 23px;
          height: 23px;
        }
      }
      
      /* Enhanced Mobile Responsiveness (480px and below) */
      @media (max-width: 480px) {
        .ai-altius-altius-chat-widget {
          bottom: 8px;
          right: 8px;
        }
        
        .ai-altius-altius-chat-popup {
          width: 98vw;
          max-width: 300px;
          height: 68vh;
          max-height: 82vh;
          bottom: 50px;
          right: 4px;
          left: 4px;
          border-radius: 16px;
        }
        
        .ai-altius-altius-chat-bubble {
          width: 56px;
          height: 56px;
        }
        
        .ai-altius-altius-chat-bubble .ai-altius-altius-chat-icon {
          width: 22px;
          height: 22px;
        }
        
        .ai-altius-altius-chat-header {
          max-height: 48px;
        }
        
        .ai-altius-altius-chat-logo {
          width: 32px;
          height: 32px;
        }
        
        .ai-altius-altius-logo-img {
          width: 24px;
          height: 24px;
        }
        
        .ai-altius-altius-chat-title {
          font-size: 14px;
        }
        
        .ai-altius-altius-chat-content {
          max-height: calc(100% - 48px);
        }
        
        .ai-altius-altius-chat-message {
          max-width: 85%;
          padding: 10px 14px;
          font-size: 13px;
        }
        
        .ai-altius-altius-chat-input-area {
          padding: 8px 8px;
          border-radius: 0 0 16px 16px;
        }
        
        .ai-altius-altius-chat-input {
          padding: 10px 14px;
          font-size: 13px;
          border-radius: 20px;
        }
        
        .ai-altius-altius-chat-send {
          width: 42px;
          height: 42px;
        }
        
        .ai-altius-altius-chat-send-icon {
          width: 22px;
          height: 22px;
        }
        
        .ai-altius-altius-chat-close {
          bottom: -45px;
          right: 8px;
          width: 40px;
          height: 40px;
          font-size: 20px;
        }
      }
      
      /* Extra Small Mobile (320px and below) */
      @media (max-width: 320px) {
        .ai-altius-altius-chat-widget {
          bottom: 12px;
          right: 12px;
        }
        
        .ai-altius-altius-chat-popup {
          width: calc(100vw - 24px);
          height: calc(100vh - 120px);
          bottom: 70px;
          right: 12px;
          left: 12px;
        }
        
        .ai-altius-altius-chat-bubble {
          width: 52px;
          height: 52px;
        }
        
        .ai-altius-altius-chat-bubble .ai-altius-altius-chat-icon {
          width: 20px;
          height: 20px;
        }
        
        .ai-altius-altius-chat-header {
          max-height: 48px;
        }
        
        .ai-altius-altius-chat-logo {
          width: 28px;
          height: 28px;
        }
        
        .ai-altius-altius-logo-img {
          width: 24px;
          height: 24px;
        }
        
        .ai-altius-altius-chat-title {
          font-size: 13px;
        }
        
        .ai-altius-altius-chat-content {
          max-height: calc(100% - 48px);
        }
        
        .ai-altius-altius-chat-message {
          max-width: 90%;
          padding: 8px 12px;
          font-size: 12px;
        }
        
        .ai-altius-altius-chat-input-area {
          padding: 8px 8px;
        }
        
        .ai-altius-altius-chat-input {
          padding: 8px 12px;
          font-size: 12px;
        }
        
        .ai-altius-altius-chat-send {
          width: 38px;
          height: 38px;
        }
        
        .ai-altius-altius-chat-send-icon {
          width: 20px;
          height: 20px;
        }
        
        .ai-altius-altius-chat-close {
          bottom: -40px;
          right: 6px;
          width: 36px;
          height: 36px;
          font-size: 18px;
        }
      }
      
      /* High DPI/Retina Display Support */
      @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
        .ai-altius-altius-chat-bubble {
          box-shadow: 0 2px 6px ${theme.colors.shadow.light};
        }
        
        .ai-altius-altius-chat-popup {
          box-shadow: 0 4px 16px ${theme.colors.shadow.dark};
        }
        
        .ai-altius-altius-chat-send {
          box-shadow: 0 2px 8px rgba(30, 192, 170, 0.2);
        }
      }
      
      /* Landscape orientation adjustments for mobile */
      @media (max-width: 767px) and (orientation: landscape) {
        .ai-altius-altius-chat-popup {
          height: calc(100vh - 100px);
          bottom: 70px;
        }
        
        .ai-altius-altius-chat-content {
          max-height: 60vh;
        }
        
        .ai-altius-altius-chat-input-area {
          padding: 8px 8px;
        }
      }
      
      /* Print styles - hide widget when printing */
      @media print {
        .ai-altius-altius-chat-widget {
          display: none !important;
        }
      }
    `;

    // Fungsi untuk menyuntikkan CSS styles ke dalam head dokumen
    function n() {
      const e = document.createElement("style");
      (e.textContent = generateStyles()), document.head.appendChild(e);
    }

    // Fungsi untuk membuat dan mengembalikan struktur HTML widget chat
    function i() {
      const e = document.createElement("div");
      return (
        (e.className = "ai-altius-altius-chat-widget"),
        (e.innerHTML = `
            <button class="ai-altius-altius-chat-bubble" id="altius-chat-toggle">
                <svg class="ai-altius-altius-chat-icon"  viewBox="0 0 24 24" width="24" height="24">
                    <path fill="white" d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-3 12H7c-.55 0-1-.45-1-1s.45-1 1-1h10c.55 0 1 .45 1 1s-.45 1-1 1zm0-3H7c-.55 0-1-.45-1-1s.45-1 1-1h10c.55 0 1 .45 1 1s-.45 1-1 1zm0-3H7c-.55 0-1-.45-1-1s.45-1 1-1h10c.55 0 1 .45 1 1s-.45 1-1 1z"/>
                </svg>
                <svg class="ai-altius-altius-close-icon" viewBox="0 0 24 24" width="24" height="24">
                    <path fill="white" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
            <div class="ai-altius-altius-chat-popup" id="altius-chat-popup">
                <div class="ai-altius-altius-chat-header">
                    <div class="ai-altius-altius-chat-logo">
                        <img src="${userAgentData.bot_logo_url}" alt="${userAgentData.bot_name} Logo" class="ai-altius-altius-logo-img" />
                    </div>
                    <div style="display:flex;flex-direction:column;align-items:flex-start;">
                      <div class="ai-altius-altius-chat-title">${userAgentData.useragent_name}</div>
                      <div class="ai-altius-altius-chat-status"><span class="ai-altius-altius-chat-status-dot"></span>Online</div>
                    </div>
                </div>
                <div class="ai-altius-altius-chat-content" id="altius-chat-content">
                    <!-- Pesan bot pertama akan dirender secara dinamis -->
                </div>
                <div class="ai-altius-altius-chat-input-area">
                    <input 
                        type="text" 
                        class="ai-altius-altius-chat-input" 
                        id="altius-chat-input"
                        placeholder="Ketik pesan Anda..."
                        maxlength="500"
                    >
                    <button class="ai-altius-altius-chat-send" id="altius-chat-send">
                        <svg class="ai-altius-altius-chat-send-icon" viewBox="0 0 24 24" width="6" height="6">
                            <path fill="currentColor" d="M2 21l21-9-21-9v7l15 2-15 2z"/>
                        </svg>
                    </button>
                </div>
                <button class="ai-altius-altius-chat-close" id="altius-chat-close">
                    <svg class="ai-altius-altius-close-icon" viewBox="0 0 24 24" width="16" height="16">
                        <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
        `),
        e
      );
    }

    // Menyimpan timestamp inisialisasi widget
    const widgetInitTime = new Date();

    // Fungsi untuk mengambil session_id dari API
    async function fetchSessionId() {
      const token = window.chat_api_key;
      if (!token) {
        throw new Error("No authentication token available");
      }
      try {
        const response = await fetch(
          "https://aionegml-dev-c3aqcqg7abhhb2ag.southeastasia-01.azurewebsites.net/create_session",
          {
            method: "GET",
            headers: {
              "qubisa-token-key": token,
            },
          }
        );
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        // Expecting { "session_id": "..." }
        window.session_id = data.session_id || null;
      } catch (error) {
        console.error("Error fetching session_id:", error);
        window.session_id = null;
      }
    }

    // Fungsi inisialisasi utama yang menyiapkan widget chat
    function a() {
      // Membuat dan menambahkan widget ke body dokumen
      const e = i();
      document.body.appendChild(e);

      // Mendapatkan referensi ke elemen DOM
      const t = document.getElementById("altius-chat-toggle"), // Tombol toggle chat
        n = document.getElementById("altius-chat-popup"), // Kontainer popup chat
        a = document.getElementById("altius-chat-close"), // Tombol tutup
        o = document.getElementById("altius-chat-input"), // Field input
        s = document.getElementById("altius-chat-send"), // Tombol kirim
        c = document.getElementById("altius-chat-content"); // Area konten chat

      // Disable input and send button until session is ready
      o.disabled = true;
      s.disabled = true;

      // Melacak status visibilitas popup
      let l = !1;

      // Menyimpan riwayat percakapan chat
      let chatHistory = [
        {
          role: "assistant",
          content: `Halo! Saya ${userAgentData.bot_name}. Ada yang bisa saya bantu?`,
        },
      ];

      // Fetch session_id and user agent details, then enable input
      Promise.all([fetchSessionId(), fetchUserAgentDetails()]).then(() => {
        o.disabled = false;
        s.disabled = !o.value.trim();
        // Render pesan selamat datang setelah data agent siap
        r(
          `Halo! Saya adalah asisten virtual AI anda. ada yang bisa saya bantu hari ini ?`,
          false,
          widgetInitTime
        );
      });

      // Toggle visibilitas popup chat
      function d() {
        (l = !l),
          l
            ? (n.classList.add("show"), t.classList.add("open"), o.focus())
            : (n.classList.remove("show"), t.classList.remove("open"));
      }

      // Fungsi untuk merender pesan chat
      // Parameter:
      // - e: konten pesan
      // - t: boolean yang menunjukkan apakah pesan dari pengguna (true) atau bot (false)
      // - customTime: timestamp kustom opsional untuk pesan
      function r(e, t = !1, customTime = null) {
        const n = document.createElement("div");
        n.className = `ai-altius-altius-chat-message ${t ? "user" : "bot"}`;

        // Reset animation untuk pesan baru
        n.style.animation = "none";
        n.offsetHeight; // Trigger reflow
        n.style.animation = null;

        // Create message header with agent name and time
        const header = document.createElement("div");
        header.className = "ai-altius-altius-chat-message-header";

        const agentName = document.createElement("span");
        agentName.textContent = t ? "Anda" : userAgentData.bot_name;

        const timestamp = document.createElement("span");
        const now = customTime ? customTime : new Date();
        timestamp.textContent = now.toLocaleTimeString("id-ID", {
          hour: "2-digit",
          minute: "2-digit",
        });

        header.appendChild(agentName);
        header.appendChild(timestamp);

        // Create message content
        const content = document.createElement("div");
        content.className = "ai-altius-altius-chat-message-content";
        content.textContent = e;

        n.appendChild(header);
        n.appendChild(content);
        c.appendChild(n);

        // Smooth scroll dengan animasi
        c.scrollTo({
          top: c.scrollHeight,
          behavior: "smooth",
        });
      }

      // Fungsi untuk menampilkan indikator typing
      function u() {
        const e = document.createElement("div");
        (e.className = "ai-altius-altius-typing-indicator"),
          (e.id = "altius-typing"),
          (e.innerHTML =
            '\n                <div class="ai-altius-altius-typing-dot"></div>\n                <div class="ai-altius-altius-typing-dot"></div>\n                <div class="ai-altius-altius-typing-dot"></div>\n            '),
          c.appendChild(e),
          c.scrollTo({
            top: c.scrollHeight,
            behavior: "smooth",
          });
      }

      // Fungsi untuk menghapus indikator typing
      function g() {
        const e = document.getElementById("altius-typing");
        e && e.remove();
      }

      // Fungsi untuk mengirim pesan ke API dan menangani respons
      async function sendMessageToAPI(prompt) {
        const token = window.chat_api_key;
        if (!token) {
          throw new Error("No authentication token available");
        }

        // Tambahkan pesan pengguna ke riwayat
        chatHistory.push({
          role: "user",
          content: prompt,
        });

        try {
          const response = await fetch(
            // "https://agiqubisaai-api-dev-fhf0cwfdbnhqcfda.southeastasia-01.azurewebsites.net/chat",
            "https://aionegml-dev-c3aqcqg7abhhb2ag.southeastasia-01.azurewebsites.net/chat",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "qubisa-token-key": token,
              },
              body: JSON.stringify({
                prompt: prompt,
                user_profile: window.personal_data,
                session_id: window.session_id,
                chat_history: chatHistory.filter(
                  (msg) => msg.role !== "system"
                ),
              }),
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          return data.response || "Maaf, terjadi kesalahan.";
        } catch (error) {
          console.error("Error sending message:", error);
          return "❌ Gagal mengirim pesan. Coba lagi.";
        }
      }

      // Fungsi untuk menangani pengiriman pesan
      async function p() {
        const e = o.value.trim();
        if (e) {
          // Tambahkan efek ripple pada tombol kirim
          const ripple = document.createElement("div");
          ripple.style.cssText = `
            position: absolute;
            border-radius: 50%;
            background: rgba(255,255,255,0.6);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
            width: 100px;
            height: 100px;
            top: 50%;
            left: 50%;
            margin-left: -50px;
            margin-top: -50px;
          `;
          s.appendChild(ripple);

          setTimeout(() => ripple.remove(), 600);

          r(e, !0); // Tampilkan pesan pengguna
          o.value = "";
          s.disabled = true;
          u(); // Tampilkan indikator typing

          try {
            const botReply = await sendMessageToAPI(e);

            // Tambahkan balasan bot ke riwayat
            chatHistory.push({
              role: "assistant",
              content: botReply,
            });

            r(botReply); // Tampilkan balasan bot
          } catch (error) {
            r("❌ Gagal mengirim pesan. Coba lagi.");
          } finally {
            g();
            s.disabled = false;
          }
        }
      }

      // Menambahkan event listener untuk interaksi widget
      t.addEventListener("click", d), // Toggle chat saat bubble diklik
        a.addEventListener("click", d), // Toggle chat saat tombol tutup diklik
        s.addEventListener("click", p), // Kirim pesan saat tombol kirim diklik
        o.addEventListener("keypress", (e) => {
          // Kirim pesan saat tombol Enter ditekan (tanpa shift)
          "Enter" !== e.key || e.shiftKey || (e.preventDefault(), p());
        }),
        o.addEventListener("input", () => {
          // Aktifkan/nonaktifkan tombol kirim berdasarkan konten input
          s.disabled = !o.value.trim();
        }),
        document.addEventListener("click", (t) => {
          // Tutup chat saat mengklik di luar
          l && !e.contains(t.target) && d();
        }),
        n.addEventListener("click", (e) => {
          // Mencegah chat tertutup saat mengklik di dalam
          e.stopPropagation();
        });
    }

    // Fungsi untuk menginisialisasi widget saat DOM siap
    function o() {
      "loading" === document.readyState
        ? document.addEventListener("DOMContentLoaded", () => {
            n(), a();
          })
        : (n(), a());
    }

    // Mengekspos API widget dan menginisialisasi
    (window.AltiusChatWidget = { version: "1.0.0", init: o, config: theme }),
      o();
  }
})();
